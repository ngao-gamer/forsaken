getgenv().Players = game:GetService("Players")
getgenv().playerData = game:GetService("Players").LocalPlayer:WaitForChild("PlayerData")
getgenv().ReplicatedStorage = game:GetService("ReplicatedStorage")
getgenv().RunService = game:GetService("RunService")
getgenv().MarketplaceService = game:GetService("MarketplaceService")
getgenv().RemoteEvent = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Network"):WaitForChild("RemoteEvent")
getgenv().TweenService = game:GetService("TweenService")
getgenv().PlayerGui = game:GetService("Players").LocalPlayer:WaitForChild("PlayerGui")
local Humanoid, Animator
getgenv().player = Players.LocalPlayer
getgenv().purchasedEmotesFolder = playerData:WaitForChild("Purchased"):WaitForChild("Emotes")
getgenv().Remote = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Network"):WaitForChild("RemoteEvent")

-- ===================================
-- == KHỞI TẠO FLUENT UI MỚI ==
-- ===================================

local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()

local Window = Fluent:CreateWindow({
   Title = "Purium Hub | by ngao-gamer",
   -- Tùy chỉnh màu sắc và cài đặt Fluent UI nếu cần
   ThemeIndex = 3, -- 3 là màu xanh mặc định (Cyan)
   AccentColor = "Cyan",
   ConfigurationSaving = {
      Enabled = true,
      FolderName = "Purium",
      FileName = "Purium Hub"
   }
})

-- Tạo các Tab
local CombatTab = Window:AddTab("Combat", 5632128825)
local GeneratorsTab = Window:AddTab("Generators", 5632128825) -- Icon tương tự package-2 (Lua's Package-2 icon is 5632128825 or similar)
local ESPTab = Window:AddTab("ESP", 5632128825) -- Sử dụng icon chung hoặc tìm icon cụ thể nếu cần
local StaminaSetTab = Window:AddTab("Stamina Settings", 5632128825)
local AimbotTab = Window:AddTab("Aimbot", 5632128825)
local MiscsTab = Window:AddTab("Misc", 5632128825)
local AntiSlowsTab = Window:AddTab("Anti Slow", 5632128825)
local AchieveTab = Window:AddTab("Achievements", 5632128825)


-- == Generators Tab ==
local genEnabled = false
local genInterval = 1.25
local re = true
local Check = false
local lt = 0

GeneratorsTab:AddSection("Auto Generator")

local autoGenToggle = GeneratorsTab:AddToggle("AutoGenToggle", {
	Title = "Auto Do Generator",
	Default = genEnabled,
}):OnChange(function(Value)
	genEnabled = Value
end)

local genIntervalSlider = GeneratorsTab:AddSlider("GenIntervalSlider", {
	Title = "Do Generator Interval (Seconds)",
	Range = {1, 15},
	Increment = 0.25,
	Suffix = "s",
	Default = genInterval,
}):OnChange(function(Value)
	genInterval = Value
end)

-- == Hook RF/RE để detect vào/ra gen + cooldown ==
local Old
Old = hookmetamethod(game, "__namecall", function(Self, ...)
	local Args = { ... }
	local Method = getnamecallmethod()
	if not checkcaller() and typeof(Self) == "Instance" then
		if Method == "InvokeServer" or Method == "FireServer" then
			if tostring(Self) == "RF" then
				if Args[1] == "enter" then
					Check = true
				elseif Args[1] == "leave" then
					Check = false
				end
			elseif tostring(Self) == "RE" then
				lt = os.clock()
			end
		end
	end
	return Old(Self, unpack(Args))
end)

-- == Auto Generator Loop ==
game:GetService("RunService").Stepped:Connect(function()
	if genEnabled and Check and re and os.clock() - lt >= genInterval then
		re = false
		task.spawn(function()
			for _, gen in ipairs(workspace.Map.Ingame:WaitForChild("Map"):GetChildren()) do
				if gen.Name == "Generator" and gen:FindFirstChild("Remotes") then
					gen.Remotes.RE:FireServer()
				end
			end
			task.wait(genInterval)
			re = true
		end)
	end
end)

-- === ESP Toggles ===
local killersESPToggle = false
local survivorsESPToggle = false
local itemESPEnabled = false

ESTab:AddSection("Main ESP")

ESTab:AddToggle("KillersESP", {
   Title = "Killers ESP",
   Default = killersESPToggle,
}):OnChange(function(Value)
   killersESPToggle = Value
end)

ESTab:AddToggle("SurvivorsESP", {
   Title = "Survivors ESP",
   Default = survivorsESPToggle,
}):OnChange(function(Value)
   survivorsESPToggle = Value
end)

-- === ESP Logic (Code này giữ nguyên vì không liên quan đến UI) ===
local camera = workspace.CurrentCamera

local killersFolder = workspace:WaitForChild("Players"):WaitForChild("Killers")
local survivorsFolder = workspace:WaitForChild("Players"):WaitForChild("Survivors")

local function attachBillboard(model, color)
    -- ... [logic giữ nguyên] ...
end

local function updateBillboardText(model)
    -- ... [logic giữ nguyên] ...
end

local noliByUsername = {}

local function clearFakeTags()
    -- ... [logic giữ nguyên] ...
end

local function scanNolis()
    -- ... [logic giữ nguyên] ...
end

local function updateFakeNolis()
    -- ... [logic giữ nguyên] ...
    clearFakeTags()
    scanNolis()
end

local function setupModel(model, isKiller)
    -- ... [logic giữ nguyên] ...
end

local function scanFolder(folder, isKiller)
    -- ... [logic giữ nguyên] ...
end

task.spawn(function()
	while true do
		scanFolder(killersFolder, true)
		scanFolder(survivorsFolder, false)
		task.wait(5)
	end
end)

local function handleChildAdded(folder, isKiller)
    -- ... [logic giữ nguyên] ...
end

handleChildAdded(killersFolder, true)
handleChildAdded(survivorsFolder, false)
updateFakeNolis()

killersFolder.ChildRemoved:Connect(function(removed)
    if removed:GetAttribute("ActorDisplayName") == "Noli" then
        updateFakeNolis()
    end
end)

killersFolder.ChildAdded:Connect(function(added)
    if added:GetAttribute("ActorDisplayName") == "Noli" then
        task.defer(function()
            task.wait(0.2)
            updateFakeNolis()
        end)
    end
end)

task.spawn(function()
    while true do
        task.wait(10)
        updateFakeNolis()
    end
end)

RunService.RenderStepped:Connect(function()
    -- ... [logic giữ nguyên] ...
end)

-- Generator ESP Logic (Các hàm giữ nguyên)
-- ... [Các hàm getProgressPercent, calculateScale, createOrUpdateProgressESP, attachESP, attachESPForExistingParts, updateGenerators, updateAllESPSizes, startGeneratorESP, stopGeneratorESP] ...

local colorByName = {
	BloxyCola = Color3.fromRGB(255, 140, 0),
	Medkit = Color3.fromRGB(255, 100, 255),
}
-- ... [Các hàm FindInTable, createNameTag, createBoxESP, enableItemESP, disableItemESP] ...

-- == Items ESP Toggle ==
ESTab:AddToggle("ItemESP_Toggle", {
	Title = "Items ESP",
	Default = itemESPEnabled,
}):OnChange(function(Value)
	itemESPEnabled = Value
	if itemESPEnabled then
		enableItemESP()
	else
		disableItemESP()
	end
end)

-- == Generators ESP Toggle ==
local generatorESPEnabled = false
ESTab:AddToggle("GeneratorsESP", {
	Title = "Generators ESP",
	Default = generatorESPEnabled,
}):OnChange(function(Value)
	generatorESPEnabled = Value
	if Value then
		startGeneratorESP()
	else
		stopGeneratorESP()
	end
end)

local ingame = workspace:WaitForChild("Map"):WaitForChild("Ingame")

-- =============================================
-- == Builderman/Taph ESP Logic (ĐÃ SỬA LỖI LAG) ==
-- =============================================
local dispenserPartNames = { "SprayCan", "UpperHolder", "Root" }
-- ... [Các hàm isDispenser, isSentry, createBillboardESP, createDispenserESP, createSentryESP] ...
-- ... [Các hàm CustomESP_isTripware, CustomESP_isSubspace, CustomESP_createTripwareESP, CustomESP_createSubspaceESP, removeESPByNamePattern] ...
-- ... [Các hàm Enable/Disable ESP (Dispenser, Sentry, Tripware, Subspace)] ...

-- Event lắng nghe object spawn (Giữ nguyên)
ingame.DescendantAdded:Connect(function(part)
    -- ... [logic giữ nguyên] ...
end)

-- Vòng lặp chính update ESP (ĐÃ SỬA LỖI LAG)
task.spawn(function()
	while true do
		local parts = ingame:GetDescendants()
		for _, part in ipairs(parts) do
			local parent = part.Parent
			if not parent then continue end
			
			if _G.DispenserESPEnabled and isDispenser(parent) then createDispenserESP(part) end
			
			if _G.SentryESPEnabled and isSentry(parent) then createSentryESP(part) end
			
			if _G.CustomESP_TripwareEnabled and CustomESP_isTripware(parent) then CustomESP_createTripwareESP(part) end
			
			if _G.CustomESP_SubspaceEnabled and CustomESP_isSubspace(parent) then CustomESP_createSubspaceESP(part) end
		end
		-- Chỉ chờ một lần duy nhất sau khi quét xong TẤT CẢ Parts
		task.wait(0.5) 
	end
end)

-- =============================================
-- == Fluent UI Toggles cho Builderman/Taph ==
-- =============================================
ESTab:AddSection("Builderman ESP")
ESTab:AddToggle("ToggleBuilderDispenserESP", {
	Title = "Dispenser ESP",
	Default = false,
}):OnChange(function(v) if v then EnableDispenserESP() else DisableDispenserESP() end end)

ESTab:AddToggle("ToggleBuilderSentryESP", {
	Title = "Sentry ESP",
	Default = false,
}):OnChange(function(v) if v then EnableSentryESP() else DisableSentryESP() end end)

ESTab:AddSection("Taph ESP")
ESTab:AddToggle("ToggleBuilderTripwareESP", {
	Title = "Tripwire ESP",
	Default = false,
}):OnChange(function(v) if v then EnableTripwareESP() else DisableTripwareESP() end end)

ESTab:AddToggle("ToggleBuilderSubspaceESP", {
	Title = "Subspace Tripmine ESP",
	Default = false,
}):OnChange(function(v) if v then EnableSubspaceESP() else DisableSubspaceESP() end end)


-- =============================================
-- == Aimbot Tab (Đã chuyển sang Fluent UI) ==
-- =============================================

-- Config global (Giữ nguyên)
getgenv().AimbotConfig = getgenv().AimbotConfig or {}
-- ... [Các cài đặt mặc định của AimbotConfig giữ nguyên] ...

-- =============================================
-- == Aimbot GUI (ĐÃ CHUYỂN FLUENT) ==
-- =============================================

AimbotTab:AddSection("Shedletsky (Slash)")
AimbotTab:AddToggle("AutoAimSlash", {
	Title = "Aimbot Slash",
	Default = getgenv().AimbotConfig.Slash.Enabled,
}):OnChange(function(Value)
	getgenv().AimbotConfig.Slash.Enabled = Value
end)
AimbotTab:AddSlider("SmoothnessSlash", {
	Title = "Smoothness Slash",
	Range = {0, 101},
	Increment = 1,
	Suffix = "ms",
	Default = getgenv().AimbotConfig.Slash.Smoothness * 100,
}):OnChange(function(Value)
	getgenv().AimbotConfig.Slash.Smoothness = Value / 100
end)
AimbotTab:AddSlider("PredictionSlash", {
	Title = "Prediction Slash",
	Range = {0, 2},
	Increment = 0.05,
	Suffix = "s",
	Default = getgenv().AimbotConfig.Slash.Prediction,
}):OnChange(function(Value)
	getgenv().AimbotConfig.Slash.Prediction = Value
end)

AimbotTab:AddSection("Chance (One Shot)")
AimbotTab:AddToggle("AutoAimShoot", {
	Title = "Aimbot One Shot",
	Default = getgenv().AimbotConfig.Shoot.Enabled,
}):OnChange(function(Value)
	getgenv().AimbotConfig.Shoot.Enabled = Value
end)
AimbotTab:AddSlider("SmoothnessShoot", {
	Title = "Smoothness One Shot",
	Range = {0, 101},
	Increment = 1,
	Suffix = "ms",
	Default = getgenv().AimbotConfig.Shoot.Smoothness * 100,
}):OnChange(function(Value)
	getgenv().AimbotConfig.Shoot.Smoothness = Value / 100
end)
AimbotTab:AddSlider("PredictionShoot", {
	Title = "Prediction One Shot",
	Range = {0, 2},
	Increment = 0.05,
	Suffix = "s",
	Default = getgenv().AimbotConfig.Shoot.Prediction,
}):OnChange(function(Value)
	getgenv().AimbotConfig.Shoot.Prediction = Value
end)

AimbotTab:AddSection("Chance (True One Shot)")
AimbotTab:AddParagraph("True One Shot Aimbot", "For Chance True One Shot Only")
AimbotTab:AddToggle("AutoAimTrueShoot", {
	Title = "Aimbot True One Shot",
	Default = getgenv().AimbotConfig.TrueShoot.Enabled,
}):OnChange(function(Value)
	getgenv().AimbotConfig.TrueShoot.Enabled = Value
end)
AimbotTab:AddSlider("SmoothnessTrueShoot", {
	Title = "Smoothness True One Shot",
	Range = {0, 101},
	Increment = 1,
	Suffix = "ms",
	Default = getgenv().AimbotConfig.TrueShoot.Smoothness * 100,
}):OnChange(function(Value)
	getgenv().AimbotConfig.TrueShoot.Smoothness = Value / 100
end)
AimbotTab:AddSlider("PredictionTrueShoot", {
	Title = "Prediction True One Shot",
	Range = {0, 2},
	Increment = 0.05,
	Suffix = "s",
	Default = getgenv().AimbotConfig.TrueShoot.Prediction,
}):OnChange(function(Value)
	getgenv().AimbotConfig.TrueShoot.Prediction = Value
end)

AimbotTab:AddSection("Guest 1337 (Punch)")
AimbotTab:AddToggle("AutoAimPunch", {
	Title = "Aimbot Punch",
	Default = getgenv().AimbotConfig.Punch.Enabled,
}):OnChange(function(Value)
	getgenv().AimbotConfig.Punch.Enabled = Value
end)
AimbotTab:AddSlider("SmoothnessPunch", {
	Title = "Smoothness Punch",
	Range = {0, 101},
	Increment = 1,
	Suffix = "ms",
	Default = getgenv().AimbotConfig.Punch.Smoothness * 100,
}):OnChange(function(Value)
	getgenv().AimbotConfig.Punch.Smoothness = Value / 100
end)
AimbotTab:AddSlider("PredictionPunch", {
	Title = "Prediction Punch",
	Range = {0, 2},
	Increment = 0.05,
	Suffix = "s",
	Default = getgenv().AimbotConfig.Punch.Prediction,
}):OnChange(function(Value)
	getgenv().AimbotConfig.Punch.Prediction = Value
end)

AimbotTab:AddSection("Elliot (Throw Pizza)")
AimbotTab:AddToggle("AutoAimThrowPizza", {
	Title = "Aimbot Throw Pizza",
	Default = getgenv().AimbotConfig.ThrowPizza.Enabled,
}):OnChange(function(Value)
	getgenv().AimbotConfig.ThrowPizza.Enabled = Value
end)
AimbotTab:AddSlider("SmoothnessThrowPizza", {
	Title = "Smoothness Throw Pizza",
	Range = {0, 101},
	Increment = 1,
	Suffix = "ms",
	Default = getgenv().AimbotConfig.ThrowPizza.Smoothness * 100,
}):OnChange(function(Value)
	getgenv().AimbotConfig.ThrowPizza.Smoothness = Value / 100
end)
AimbotTab:AddSlider("PredictionThrowPizza", {
	Title = "Prediction Throw Pizza",
	Range = {0, 2},
	Increment = 0.2,
	Suffix = "s",
	Default = getgenv().AimbotConfig.ThrowPizza.Prediction,
}):OnChange(function(Value)
	getgenv().AimbotConfig.ThrowPizza.Prediction = Value
end)

AimbotTab:AddSection("Killers")
AimbotTab:AddToggle("EnableAimbotAll", {
	Title = "Killers's Aimbot",
	Default = getgenv().AimbotConfig.Killers.Enabled,
}):OnChange(function(Value)
	getgenv().AimbotConfig.Killers.Enabled = Value
end)

AimbotTab:AddSection("AimMode")
AimbotTab:AddDropdown("AimModeSelect", {
	Title = "Aim Mode",
	Options = {"Aimbot", "RootPart"},
	Default = getgenv().AimbotConfig.Mode,
}):OnChange(function(Value)
	-- Fluent trả về một bảng với tùy chọn được chọn, lấy phần tử đầu tiên
	getgenv().AimbotConfig.Mode = Value[1] 
end)

-- Hàm kiểm tra skill Killers (Giữ nguyên)
local function isKillerSkill(skillName)
    -- ... [logic giữ nguyên] ...
end
-- ... [Script Emotes phụ và các code còn lại giữ nguyên] ...
